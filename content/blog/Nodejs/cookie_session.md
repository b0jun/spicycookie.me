---
title: '쿠키 / 세션 인증'
date: '2020-12-24'
category: 'Node.js'
private: true
---

# 🍪 쿠키와 세션을 왜 사용할까?

클라이언트와 서버가 통신을 할때는, 서버가 클라이언트의 인증을 계속 해야햐는데, HTTP 프로토콜의 특징인 Stateless 때문에 클라이언트의 상태 정보를 알 수 없어 인증 정보가 유지되지 않는다.
이러한 상태를 유지하기 위해서 쿠키와 세션이라는 방법이 존재한다.

> Stateless(무상태): 요청 간 각각의 통신 파트너에 대한 상태를 보관하지않는다.

# 🍪 쿠키 (Cookie)

쿠키는 `키와 값(key, value)`형태로 구성되어있다. 어떤 웹 사이트에 들어갔을 때, 서버가 사용자 웹 브라우저에 전송하는 작은 데이터로, 브라우저는 쿠키를 저장해 놓았다가, 동일한 서버에 재 요청시 데이터를 함께 전송한다.
즉, 해당 도메인에 대한 쿠키가 존재하면, 웹 브라우저는 도메인에게 http 요청 시 쿠키를 함께 전달한다.

## 쿠키가 주로 사용되는 곳

- 로그인
- 장바구니
- 사용자 선호 테마
- 사용자 트래킹 정보

## 서버에서 클라이언트로 쿠키 전송 방법

쿠키는 서버에서 HTTP 응답 헤더에 Set-Cookie 속성을 통하여 클라이언트에게 제공할 수 있다.

### 쿠키 전송 방식 예시(ex. 로그인 정보 확인)

<center><img src="./images/cookie_session_1.png" alt="cookie_session_1" /></center>

1. 클라이언트가 서버에 로그인 요청
2. 서버는 요청 데이터의 유효성 확인 후, 응답헤더에 쿠키를 담아 응답
3. 클라이언트는 서버에서 받은 쿠키를 자동으로 요청헤더에 추가해 유저 정보를 요청
4. 서버는 쿠키를 확인 한 후, 유저 정보를 응답

## 쿠키 옵션

### 📖 Domain

클라이언트에서 Domain에 설정된 도메인값과 서버의 도메인이 일치해야만 쿠키를 전송할 수 있다.

### 📖 Path

서버가 라우팅할 때 사용하는 경로로, Path 값을 만족하는 모든 경로는 쿠키를 전송할 수 있다.
기본값은 `/`이며, 만약 Path값이 `/user`로 설정되어 있고, 요청하는 URL이 `http://localhost.com:3000/user/login` 이여도 쿠키를 전송이 가능하다.

> Path 값은 `http://localhost:3000/user` 가 있으면 /user를 뜻한다.

### 📖 MaxAge / Expires

쿠키의 유효기간을 정하는 옵션이다. 유효기간이 지나면 쿠키는 자동으로 파괴된다.

- MaxAge: 앞으로 몇 초 동안 쿠키가 유효한지 설정
- Expires: 클라이언트를 기준으로 언제까지 유효한지 Date값으로 나타냄

### 📖 Secure

쿠키를 전송해야 할 때, 사용하는 프로토콜에 따른 쿠키전송 여부를 결정한다.
만약 해당 옵션이 `true` 라면, `HTTPS` 프로토콜을 이용하는 경우에만 쿠키를 전송할 수 있다.

### 📖 HttpOnly

자바스크립트에서 브라우저의 쿠키에 접근 여부를 결정한다.
만약 해당 옵션이 `true` 라면, 자바스크립트에선 쿠키에 접근이 불가능하다.
명시되어 있지 않을 경우, 기본값으로 `false`로 지정되어있다. 이 경우 XSS 공격에 취약하다.

```
<script>alert(document.cookie)</script>
```

> HttpOnly옵션을 true로 설정해 document.cookie를 이용해 쿠키에 접속하는 것을 막아 XSS 공격을 사전에 방지 할 수 있다.

### 📖 SameSite

Cross-Origin 요청을 받은 경우 요청에서 사용한 메소드와 해당 옵션의 조합으로 서버의 쿠키 전송 여부를 결정하게 된다.

- Lax :Cross-Origin 요청이면 'GET' 메소드에 대해서만 쿠키를 전송
- Strict : Cross-Origin이 아닌 same-site 인 경우에만 쿠키를 전송
- None: 항상 쿠키를 보내줄 수 있고, 다만 쿠키 옵션 중 Secure 옵션이 필요함

---

세션을 주로 사용하면 좋은데 왜 굳이 쿠키를 사용할까?
→ 세션은 서버에 데이터를 저장 즉, 서버의 자원을 사용하기 때문에 서버 자원에 한계가 있고 메모리를 사용하다보면 속도 저하도 올 수 있기 때문이다.

쿠키 기반 인증 (Cookie-based Authentication)

이러한 쿠키의 특성을 이용하여 서버는 클라이언트에 인증정보를 담은 쿠키를 전송하고, 클라이언트는 전달받은 쿠키를 요청과 같이 전송하여 Stateless 한 인터넷 연결을 Stateful 하게 유지할 수 있습니다.

하지만 기본적으로는 쿠키는 오랜 시간 동안 유지될 수 있고, 자바스크립트를 이용해서 쿠키에 접근할 수 있기 때문에 인증정보가 유출되기에 십상이었습니다.

이런 인증정보를 탈취하여 서버에 요청을 보낸다면 서버는 누가 요청을 보낸 건지 상관하지 않고 인증된 유저의 요청으로 취급하기 때문에, 개인 유저 정보 같은 민감한 정보에 접근이 가능합니다.

따라서 오랫동안 클라이언트에 저장이 가능하다는 특징은 장점이자 단점이 되어서 쿠키에 인증 정보를 담아 보관하는 쿠키 기반 인증 방식은 많이 사용되지 않는 방법이 되었습니다.

다만 인증정보 대신에 쇼핑몰의 카트에 담긴 내용 같은 민감하지 않은 정보나 여러 옵션을 장기 보관하는 용도로 현재까지도 쿠키는 유용하게 사용되고 있습니다.
